Running ExUnit with seed: 413027, max_cases: 20

......................****............................................................................................

  1) test approve イベント 画像を承認して公開する (OmniArchiveWeb.ApprovalLiveTest)
     test/omni_archive_web/live/approval_live_test.exs:49
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1839,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-32-1",
           ptif_path: "/path/to/pending.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1950,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1950,
             filename: "test_report_1671.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/approval_live.ex:113: anonymous fn/5 in OmniArchiveWeb.ApprovalLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5
       (omni_archive 0.2.7) lib/omni_archive_web/endpoint.ex:1: OmniArchiveWeb.Endpoint.plug_builder_call/2
       (omni_archive 0.2.7) lib/omni_archive_web/endpoint.ex:1: OmniArchiveWeb.Endpoint.call/2
       (phoenix 1.8.3) lib/phoenix/test/conn_test.ex:225: Phoenix.ConnTest.dispatch/5



  2) test delete イベント 削除ボタンでエントリがリストから消える (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:214
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1840,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-20-1",
           ptif_path: "/path/to/delete.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1952,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1952,
             filename: "test_report_1799.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

...

  3) test delete イベント draft ステータスの画像は削除できない (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:232
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1843,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-21-1",
           ptif_path: "/path/to/draft.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1955,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1955,
             filename: "test_report_6210.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

....

  4) test approve イベント 画像を承認して公開する (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:108
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1847,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-15-1",
           ptif_path: "/path/to/pending.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1959,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1959,
             filename: "test_report_1062.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5



  5) test mount/3 レビュー待ちの画像が表示される (OmniArchiveWeb.ApprovalLiveTest)
     test/omni_archive_web/live/approval_live_test.exs:16
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1846,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-30-1",
           ptif_path: "/path/to/pending.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1957,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1957,
             filename: "test_report_1699.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/approval_live.ex:113: anonymous fn/5 in OmniArchiveWeb.ApprovalLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5
       (omni_archive 0.2.7) lib/omni_archive_web/endpoint.ex:1: OmniArchiveWeb.Endpoint.plug_builder_call/2
       (omni_archive 0.2.7) lib/omni_archive_web/endpoint.ex:1: OmniArchiveWeb.Endpoint.call/2
       (phoenix 1.8.3) lib/phoenix/test/conn_test.ex:225: Phoenix.ConnTest.dispatch/5

......

  6) test select_image イベント インスペクターを閉じることができる (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:165
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1850,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-18-1",
           ptif_path: "/path/to/close.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1964,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1964,
             filename: "test_report_1349.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

.......

  7) test reject イベント 画像を差し戻す (OmniArchiveWeb.ApprovalLiveTest)
     test/omni_archive_web/live/approval_live_test.exs:68
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1854,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-33-1",
           ptif_path: "/path/to/pending.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1970,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1970,
             filename: "test_report_1668.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/approval_live.ex:113: anonymous fn/5 in OmniArchiveWeb.ApprovalLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5
       (omni_archive 0.2.7) lib/omni_archive_web/endpoint.ex:1: OmniArchiveWeb.Endpoint.plug_builder_call/2
       (omni_archive 0.2.7) lib/omni_archive_web/endpoint.ex:1: OmniArchiveWeb.Endpoint.call/2
       (phoenix 1.8.3) lib/phoenix/test/conn_test.ex:225: Phoenix.ConnTest.dispatch/5

..

  8) test mount/3 pending_review の画像が表示される (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:22
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1857,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-10-1",
           ptif_path: "/path/to/pending.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1973,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1973,
             filename: "test_report_1733.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

.....

  9) test Validation Badge ラベル未設定には ⚠ 要確認 バッジが表示される (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:94
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1862,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: nil,
           ptif_path: "/path/to/warning.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1978,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1978,
             filename: "test_report_266.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

.

 10) test Validation Badge 有効なデータには ✓ OK バッジが表示される (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:80
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1864,
           page_number: 1,
           image_path: "priv/static/uploads/test.png",
           geometry: %{"height" => 100, "width" => 100, "x" => 0, "y" => 0},
           caption: "第1図 テスト土器",
           label: "fig-14-1",
           ptif_path: "/path/to/valid.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1980,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1980,
             filename: "test_report_1446.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

...

 11) test select_image イベント geometry 付き画像選択で SVG viewBox クロップが表示される (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:144
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1865,
           page_number: 1,
           image_path: "priv/static/uploads/test.png",
           geometry: %{"height" => 80, "width" => 100, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-17-1",
           ptif_path: "/path/to/crop.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1982,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1982,
             filename: "test_report_1478.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

...

 12) test reject イベント（Note 付き差し戻し） 差し戻しモーダルを開いて実行する (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:187
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1868,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-19-1",
           ptif_path: "/path/to/reject.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1987,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1987,
             filename: "test_report_2440.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

....

 13) test select_image イベント カード選択でインスペクターが表示される (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:126
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1873,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-16-1",
           ptif_path: "/path/to/inspect.tif",
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1992,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1992,
             filename: "test_report_682.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

...

 14) test mount/3 PTIF なしの pending_review 画像には処理中プレースホルダーが表示される (OmniArchiveWeb.Admin.ReviewLiveTest)
     test/omni_archive_web/live/admin/admin_review_live_test.exs:65
     ** (KeyError) key :site not found in:

         %OmniArchive.Ingestion.ExtractedImage{
           __meta__: #Ecto.Schema.Metadata<:loaded, "extracted_images">,
           id: 1878,
           page_number: 1,
           image_path: "priv/static/uploads/pages/test/page-001.png",
           geometry: %{"height" => 300, "width" => 200, "x" => 10, "y" => 20},
           caption: "第1図 テスト土器",
           label: "fig-13-1",
           ptif_path: nil,
           status: "pending_review",
           custom_metadata: %{},
           review_comment: nil,
           lock_version: 2,
           pdf_source_id: 1999,
           pdf_source: %OmniArchive.Ingestion.PdfSource{
             __meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">,
             id: 1999,
             filename: "test_report_1577.pdf",
             page_count: 10,
             status: "ready",
             workflow_status: "wip",
             return_message: nil,
             deleted_at: nil,
             user_id: nil,
             user: #Ecto.Association.NotLoaded<association :user is not loaded>,
             extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>,
             image_count: 0,
             owner_email: nil,
             inserted_at: ~U[2026-02-20 23:34:25Z],
             updated_at: ~U[2026-02-20 23:34:25Z]
           },
           iiif_manifest: nil,
           owner_id: nil,
           owner: #Ecto.Association.NotLoaded<association :owner is not loaded>,
           worker_id: nil,
           worker: #Ecto.Association.NotLoaded<association :worker is not loaded>,
           inserted_at: ~U[2026-02-20 23:34:25Z],
           updated_at: ~U[2026-02-20 23:34:25Z]
         }

     stacktrace:
       (omni_archive 0.2.7) lib/omni_archive_web/live/admin/review_live.ex:331: anonymous fn/6 in OmniArchiveWeb.Admin.ReviewLive.render/1
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:729: Phoenix.LiveView.Diff.process_keyed/5
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:665: anonymous fn/6 in Phoenix.LiveView.Diff.traverse_keyed/8
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:646: Phoenix.LiveView.Diff.traverse_keyed/8
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:529: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:609: anonymous fn/3 in Phoenix.LiveView.Diff.traverse_dynamic/6
       (elixir 1.19.5) lib/enum.ex:2520: Enum."-reduce/3-lists^foldl/2-0-"/3
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:419: Phoenix.LiveView.Diff.traverse/6
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/diff.ex:146: Phoenix.LiveView.Diff.render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:291: Phoenix.LiveView.Static.to_rendered_content_tag/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/static.ex:171: Phoenix.LiveView.Static.do_render/4
       (phoenix_live_view 1.1.22) lib/phoenix_live_view/controller.ex:39: Phoenix.LiveView.Controller.live_render/3
       (phoenix 1.8.3) lib/phoenix/router.ex:416: Phoenix.Router.__call__/5

.................................................................................08:34:26.291 [error] [PdfProcessor] Command failed with exit code 1: I/O Error: Couldn't open file '/nonexistent/test.pdf': No such file or directory.

.........08:34:26.312 [error] [PdfProcessor] Command failed with exit code 1: I/O Error: Couldn't open file '/nonexistent/test.pdf': No such file or directory.

08:34:26.313 [error] Task #PID<0.1762.0> started from #PID<0.1759.0> terminating
** (Ecto.StaleEntryError) attempted to update a stale struct:

%OmniArchive.Ingestion.PdfSource{__meta__: #Ecto.Schema.Metadata<:loaded, "pdf_sources">, id: 2084, filename: "test_report_2757.pdf", page_count: 10, status: "uploading", workflow_status: "wip", return_message: nil, deleted_at: nil, user_id: nil, user: #Ecto.Association.NotLoaded<association :user is not loaded>, extracted_images: #Ecto.Association.NotLoaded<association :extracted_images is not loaded>, image_count: 0, owner_email: nil, inserted_at: ~U[2026-02-20 23:34:26Z], updated_at: ~U[2026-02-20 23:34:26Z]}

This typically happens when the struct no longer exists in the database or a database trigger/rule has forbidden the action. If stale entries are expected, you may use `:stale_error_field` to convert this into a changeset error, or set `:allow_stale` to true if you would like stale operations to be considered a success (such as a stale deletion)

    (ecto 3.13.5) lib/ecto/repo/schema.ex:1023: Ecto.Repo.Schema.apply/4
    (ecto 3.13.5) lib/ecto/repo/schema.ex:594: anonymous fn/15 in Ecto.Repo.Schema.do_update/4
    (omni_archive 0.2.7) lib/omni_archive/pipeline/pipeline.ex:139: OmniArchive.Pipeline.run_pdf_extraction/4
    (elixir 1.19.5) lib/task/supervised.ex:105: Task.Supervised.invoke_mfa/2
Function: #Function<7.39430441/0 in OmniArchive.PipelineTest."test run_pdf_extraction/3 PDF 抽出開始時にパイプライン開始イベントをブロードキャストする"/1>
    Args: []
..................................................
Finished in 1.2 seconds (0.6s async, 0.6s sync)
313 tests, 14 failures, 4 skipped
